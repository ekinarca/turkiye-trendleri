---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ArchiveBadge from '../../components/ArchiveBadge.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../utils/date';
import { 
  isArchived, 
  isOldArticle, 
  getArticleAge,
  getDateParts,
  MONTH_NUMBER_TO_SLUG,
  TURKISH_MONTHS
} from '../../utils/archive';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const { title, summary, category, tags, readingTime, publishedAt, sources, trendQuery } = post.data;

// Ar≈üiv bilgileri
const archived = isArchived(publishedAt);
const old = isOldArticle(publishedAt);
const age = getArticleAge(publishedAt);
const { year, month, day } = getDateParts(publishedAt);
const monthSlug = MONTH_NUMBER_TO_SLUG[month];

// ƒ∞lgili makaleler
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .filter(p => 
    p.data.category === category || 
    p.data.tags.some(t => tags.includes(t)) ||
    p.data.trendQuery.toLowerCase().includes(trendQuery.toLowerCase().split(' ')[0])
  )
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 3);

// Breadcrumb
const breadcrumbItems = [
  { label: 'Ana Sayfa', href: '/' },
  { label: category, href: `/kategoriler/${category.toLowerCase().replace('ƒü', 'g').replace('ƒ±', 'i').replace('≈ü', 's')}` },
  { label: title.slice(0, 40) + (title.length > 40 ? '...' : ''), href: `/haber/${post.slug}` },
];

// JSON-LD Schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": title,
  "description": summary,
  "datePublished": publishedAt,
  "dateModified": publishedAt,
  "author": {
    "@type": "Organization",
    "name": "T√ºrkiye Trendleri"
  },
  "publisher": {
    "@type": "Organization",
    "name": "T√ºrkiye Trendleri",
    "logo": {
      "@type": "ImageObject",
      "url": new URL('/favicon.svg', Astro.site).toString()
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": new URL(`/haber/${post.slug}`, Astro.site).toString()
  },
  "articleSection": category,
  "keywords": tags.join(', '),
  "wordCount": post.body.split(/\s+/).length,
  "citation": sources.map(s => ({
    "@type": "WebPage",
    "name": s.title,
    "url": s.url
  }))
};
---

<BaseLayout title={title} description={summary}>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  
  <article class="article-page">
    <Breadcrumb items={breadcrumbItems} />
    
    <header class="article-header">
      <div class="article-meta-top">
        <a href={`/kategoriler/${category.toLowerCase().replace('ƒü', 'g').replace('ƒ±', 'i').replace('≈ü', 's')}`} class="category-badge">
          {category}
        </a>
        <span class="trend-badge">üìà {trendQuery}</span>
        {archived && (
          <span class="archive-badge" title={`Bu haber ${age} g√ºn √∂nce yayƒ±nlandƒ±`}>
            üìÖ Ar≈üiv
          </span>
        )}
      </div>
      
      <h1>{title}</h1>
      
      <p class="summary">{summary}</p>
      
      <div class="article-info">
        <time datetime={publishedAt}>
          üóìÔ∏è {formatDate(publishedAt)}
        </time>
        <span>‚è±Ô∏è {readingTime} dakika okuma</span>
        <span>üì∞ {sources.length} kaynak</span>
        <a href={`/arsiv/${year}/${monthSlug}/${day}`} class="archive-link">
          üìö Bu g√ºn√ºn ar≈üivi
        </a>
      </div>

      {tags.length > 0 && (
        <div class="tags">
          {tags.map((tag) => (
            <span class="tag">#{tag}</span>
          ))}
        </div>
      )}
    </header>

    {/* Eski makale uyarƒ±sƒ± */}
    {old && (
      <div class="old-article-warning">
        <span class="icon">‚è∞</span>
        <div>
          <strong>Bu haber {age} g√ºn √∂nce yayƒ±nlandƒ±</strong>
          <p>Bilgiler g√ºncelliƒüini kaybetmi≈ü olabilir. G√ºncel bilgi i√ßin kaynaklarƒ± kontrol edin.</p>
        </div>
      </div>
    )}

    <div class="article-content">
      <Content />
    </div>

    <footer class="article-footer">
      <section class="sources-section">
        <h2>üìö Kaynaklar</h2>
        <p class="sources-note">
          Bu haber a≈üaƒüƒ±daki kaynaklardan derlenen bilgilere dayanarak olu≈üturulmu≈ütur:
        </p>
        <ul class="sources-list">
          {sources.map((source) => (
            <li>
              <a href={source.url} target="_blank" rel="noopener noreferrer">
                {source.title}
              </a>
              {source.publisher && <span class="publisher">‚Äî {source.publisher}</span>}
            </li>
          ))}
        </ul>
      </section>

      {/* ƒ∞lgili Makaleler */}
      {relatedPosts.length > 0 && (
        <section class="related-section">
          <h2>üì∞ ƒ∞lgili Haberler</h2>
          <div class="related-grid">
            {relatedPosts.map((relatedPost) => (
              <ArticleCard post={relatedPost} />
            ))}
          </div>
        </section>
      )}

      <div class="disclaimer">
        <strong>‚ö†Ô∏è Uyarƒ±:</strong> Bu i√ßerik yapay zeka tarafƒ±ndan otomatik olarak olu≈üturulmu≈ütur. 
        Bilgilerin doƒüruluƒüunu yukarƒ±daki kaynaklardan kontrol etmenizi √∂neririz.
      </div>

      <nav class="article-nav">
        <a href="/" class="nav-link">‚Üê Ana Sayfa</a>
        <a href="/arsiv" class="nav-link">Ar≈üiv üìö</a>
        <a href="/trendler" class="nav-link">Trendler ‚Üí</a>
      </nav>
    </footer>
  </article>
</BaseLayout>

<style>
  .article-page {
    max-width: var(--content-width);
    margin: 0 auto;
  }

  .article-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .article-meta-top {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
    align-items: center;
  }

  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--color-primary);
    color: white;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 20px;
  }

  .category-badge:hover {
    text-decoration: none;
    background: var(--color-primary-dark);
  }

  .trend-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    font-size: 0.8125rem;
    border-radius: 20px;
    color: var(--color-text-secondary);
  }

  .archive-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: #e8f4f8;
    border: 1px solid #b8d4e3;
    border-radius: 4px;
    font-size: 0.75rem;
    color: #2c5282;
  }

  .article-header h1 {
    font-size: 2rem;
    line-height: 1.3;
    margin-bottom: 1rem;
  }

  .summary {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .article-info {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .archive-link {
    color: var(--color-link);
    font-size: 0.875rem;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    font-size: 0.8125rem;
    color: var(--color-link);
    background: rgba(0, 102, 204, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  /* Old Article Warning */
  .old-article-warning {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: #fff8e6;
    border: 1px solid #f0c36d;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .old-article-warning .icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .old-article-warning strong {
    display: block;
    color: #8a6d3b;
    margin-bottom: 0.25rem;
  }

  .old-article-warning p {
    margin: 0;
    font-size: 0.875rem;
    color: #8a6d3b;
  }

  /* Article Content Styling */
  .article-content {
    line-height: 1.8;
    font-size: 1.0625rem;
  }

  .article-content :global(h2) {
    font-size: 1.375rem;
    margin: 2rem 0 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .article-content :global(h3) {
    font-size: 1.125rem;
    margin: 1.5rem 0 0.75rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.25rem;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .article-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid var(--color-primary);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--color-text-secondary);
    font-style: italic;
  }

  .article-content :global(strong) {
    font-weight: 600;
  }

  /* Footer */
  .article-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }

  .sources-section {
    margin-bottom: 2rem;
  }

  .sources-section h2 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
  }

  .sources-note {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .sources-list {
    list-style: none;
    padding: 0;
  }

  .sources-list li {
    padding: 0.75rem;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.9375rem;
  }

  .sources-list a {
    font-weight: 500;
  }

  .publisher {
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
  }

  /* Related Section */
  .related-section {
    margin-bottom: 2rem;
  }

  .related-section h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .disclaimer {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.875rem;
    margin-bottom: 2rem;
  }

  .article-nav {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .nav-link {
    padding: 0.75rem 1.25rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .nav-link:hover {
    text-decoration: none;
    border-color: var(--color-primary);
    background: white;
  }

  @media (max-width: 768px) {
    .article-header h1 {
      font-size: 1.5rem;
    }

    .summary {
      font-size: 1rem;
    }

    .article-info {
      flex-direction: column;
      gap: 0.5rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .article-nav {
      flex-direction: column;
    }
  }
</style>
